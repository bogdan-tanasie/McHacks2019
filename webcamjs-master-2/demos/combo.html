<!doctype html>

<html lang="en">

<head>

<!-- <script src='https://cdn.jsdelivr.net/jquery.cloudinary/1.0.18/jquery.cloudinary.js' type='text/javascript'></script>
<script src="//widget.cloudinary.com/global/all.js" type="text/javascript"></script>-->
<script src="/script.js"></script>
	<script src="https://www.gstatic.com/firebasejs/5.8.2/firebase-app.js"></script>
		<script src="https://www.gstatic.com/firebasejs/5.8.2/firebase-storage.js"></script>
		<script src="https://www.gstatic.com/firebasejs/5.8.2/firebase.js"></script>
		<script>
		  // Initialize Firebase
		  var config = {
			apiKey: "AIzaSyDH7oz--r4LrQJBAJ9PGBL5AhX-O6e5mGs",
			authDomain: "mcadvisor-e679e.firebaseapp.com",
			databaseURL: "https://mcadvisor-e679e.firebaseio.com",
			projectId: "mcadvisor-e679e",
			storageBucket: "mcadvisor-e679e.appspot.com",
			messagingSenderId: "886173092547"
		  };
		  firebase.initializeApp(config);
		</script>

	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<title>Set Identification Photo</title>
	<style type="text/css">
		body { font-family: Helvetica, sans-serif; }
		h1, h2, h3 { margin-top:0; margin-bottom:0; }
		form { margin-top: 15px; }
		form input { margin-right: 15px; }
		#results { display:inline-block; margin:20px; padding:20px; border:1px solid; background:#ccc; }
	</style>
</head>
<body>
	
	<h1></h1
	<h3></h3>
	<div style="margin-top:5px; margin-bottom:20px;">Take a clear picture for future identificion.</div>
	
	<div id="my_photo_booth">
		<div id="my_camera"></div>
		
		<!-- First, include the Webcam.js JavaScript Library -->
		<script type="text/javascript" src="../webcam.min.js"></script>
		
		<!-- Configure a few settings and attach camera -->
		<script language="JavaScript">
			Webcam.set({
				// live preview size
				width: 320,
				height: 240,
				
				// device capture size
				dest_width: 640,
				dest_height: 480,
				
				// final cropped size
				crop_width: 480,
				crop_height: 480,
				
				// format and quality
				image_format: 'jpeg',
				jpeg_quality: 90,
				
				// flip horizontal (mirror mode)
				flip_horiz: true
			});
			Webcam.attach( '#my_camera' );
		</script>
		
		<!-- A button for taking snaps -->
		<form>
			<div id="pre_take_buttons">
				<!-- This button is shown before the user takes a snapshot -->
				<input type=button value="Take Snapshot" onClick="preview_snapshot()">
			</div>
			<div id="post_take_buttons" style="display:none">
				<!-- These buttons are shown after a snapshot is taken -->
				<input type=button value="&lt; Take Another" onClick="cancel_preview()">
				<input type=button value="Save Photo &gt;" onClick="save_photo()" style="font-weight:bold;">
			</div>
		</form>
	</div>
	
	<div id="results" style="display:none">
		<!-- Your captured image will appear here... -->
	</div>
	
	<!-- Code to handle taking the snapshot and displaying it locally -->
	<script language="JavaScript">

	function faceDetect(pictureURL) {

        var result = "";

        // Request parameters.
        var params = {
            "returnFaceId": "true",
            "returnFaceLandmarks": "false",
            "returnFaceAttributes": ""
        };

        // Display the image.
        var sourceImageUrl = pictureURL; //document.getElementById("inputImage").value;
        //document.querySelector("#sourceImage").src = sourceImageUrl;

        // Perform the REST API call.
        $.ajax({
            url:  "https://canadacentral.api.cognitive.microsoft.com/face/v1.0/detect?" + $.param(params),

            // Request headers.
            beforeSend: function(xhrObj){
                xhrObj.setRequestHeader("Content-Type","application/json");
                xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key", "356733d2505046d59fe44976393c4635");
            },

            type: "POST",

            // Request body.
            data: '{"url": ' + '' + "https://firebasestorage.googleapis.com/v0/b/mcadvisor-e679e.appspot.com/o/1549178990595-bunny?alt=media&token=5d12859f-6448-44f4-a245-c61b63360318" + '}',
        })

        .done(function(data) {

            const dataptr = JSON.stringify(data);
            var id1 = JSON.parse(dataptr)[0].faceId.toString();

            console.log(id1);
            //faceCompare(id1, id1);

        })

        .fail(function(jqXHR, textStatus, errorThrown) {
            // Display error message.
            var errorString = (errorThrown === "") ?
                "Error. " : errorThrown + " (" + jqXHR.status + "): ";
            errorString += (jqXHR.responseText === "") ?
                "" : (jQuery.parseJSON(jqXHR.responseText).message) ?
                    jQuery.parseJSON(jqXHR.responseText).message :
                        jQuery.parseJSON(jqXHR.responseText).error.message;
            alert(errorString);
        });

        return result;
    }



	function faceCompare(id1, id2) {


        var bodyAPI = '{"faceId1": "' + id1 +'", "faceId2": "'+ id2 +'"}';

        //console.log(bodyAPI);
        $.ajax({
            url:  "https://canadacentral.api.cognitive.microsoft.com/face/v1.0/verify",

            // Request headers.
            beforeSend: function(xhrObj){
                xhrObj.setRequestHeader("Content-Type","application/json");
                xhrObj.setRequestHeader("Ocp-Apim-Subscription-Key", "356733d2505046d59fe44976393c4635");
            },

            type: "POST",

            // Request body

            data: bodyAPI,
        })

        .done(function(data) {

            const dataptr = JSON.stringify(data);

            assert(JSON.parse(dataptr).isIdentical);

        })

        .fail(function(jqXHR, textStatus, errorThrown) {
            // Display error message.
            var errorString = (errorThrown === "") ?
                "Error. " : errorThrown + " (" + jqXHR.status + "): ";
            errorString += (jqXHR.responseText === "") ?
                "" : (jQuery.parseJSON(jqXHR.responseText).message) ?
                    jQuery.parseJSON(jqXHR.responseText).message :
                        jQuery.parseJSON(jqXHR.responseText).error.message;
            alert(errorString);
        });
    }

		// preload shutter audio clip
		var shutter = new Audio();
		shutter.autoplay = false;
		shutter.src = navigator.userAgent.match(/Firefox/) ? 'shutter.ogg' : 'shutter.mp3';
		
		function preview_snapshot() {
			// play sound effect
			try { shutter.currentTime = 0; } catch(e) {;} // fails in IE
			shutter.play();
			
			// freeze camera so user can preview current frame
			Webcam.freeze();
			
			// swap button sets
			document.getElementById('pre_take_buttons').style.display = 'none';
			document.getElementById('post_take_buttons').style.display = '';
		}
		
		function cancel_preview() {
			// cancel preview freeze and return to live camera view
			Webcam.unfreeze();
			
			// swap buttons back to first set
			document.getElementById('pre_take_buttons').style.display = '';
			document.getElementById('post_take_buttons').style.display = 'none';
		}
		
		function save_photo() {
			// actually snap photo (from preview freeze) and display it
			Webcam.snap( function(data_uri) {
	
				// display results in page
				document.getElementById('results').innerHTML = 
					'<h2></h2>' + 
					'<img src="'+data_uri+'"/><br/></br>' + 

					//console.log(data_uri);

					//'<a href="'+data_uri+'" target="_blank">Save image to McAdvisor Online Profile</a>';
					//'<a href="'+data_uri+'" download="pic1.jpg">Save image to McAdvisor Online Profile</a>';
  
					const image_data = data_uri.substr(23);
					const ref = firebase.storage().ref();
					const name = (+new Date()) + '-' + 'bunny';
					const task = ref.child(name).putString(image_data, "base64", {contentType:"image/png"});
					task.then((snapshot) => {
						snapshot.ref.getDownloadURL().then((downloadUrl) => {
							faceDetect(downloadUrl);
							//console.log(downloadUrl);
						});
					});
	
				
				// shut down camera, stop capturing
				Webcam.reset();
				
				// show results, hide photo booth
				document.getElementById('results').style.display = '';
				document.getElementById('my_photo_booth').style.display = 'none';
			} );
		}
</script>

<a href="../../dashboard.html">Continue</a>
	
</body>

<script type="text/javascript" src="facedetect.js"></script>
</html>
